---
title: "Differential Expression analysis"
author: "Ruiyu Ray Wang"
date: "`r Sys.Date()`"
output: html_document
---

Change log:

* 2022/03/08
  - Using updated dataset, incorporating neurohypophysis populations

* 2021/02/24
  - Changed from using leiden clustering as criteria to distinguish inflammation/healthy to using SCENIC hierachical clustering of AUC scores (hclust.AUC).
  - Trying to address compatibility issue between Seurat objects with stable ids and gene symbols.

* 2020/11/30
  - Transferring DE pipeline from /manuscript/fig2/Stable id plot and GO analysis 20201127.Rmd

* 2020/07/26
  - Changing from working with Gene id (short names) to Ensembl id. Also maintains a translation mechanism (gencode.vM21.genename), keeping both short names and Ensembl ids in tables.. Enrichment analysis requires input as Ensembl ids.


```{r include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

## Initialization

Load data and used libraries.

```{r}
cells <- readRDS('../data/cells.rds")
```

```{r}
library(Seurat)
library(tidyverse)
# library(SeuratDisk)
library(grid)
library(ggplot2)
library(awesomeSC)
```
```{r}
major.cellpops.lps <- subset(
  cells, subset = cell_type %in% c("Somatotropes", "Lactotropes", "Corticotropes", "Gonadotropes",
                                   "Thyrotropes", "Melanotropes","Pituicyte") &
                  stim %in% c("Ctrl", "LPS 50mg 6h", "LPS 50mg 3h", "LPS 10mg 6h", "LPS 10mg 3h",
                              "LPS 500ug 6h", "LPS >3w", "LPS 500ug 3h", "LPS 500ug 2d", "LPS 500ug 1d")
  )
```

```{r}
major.cellpops.lps <- major.cellpops.lps %>%
  NormalizeData() %>%
  FindVariableFeatures() %>%
  ScaleData() %>%
  RunPCA() %>%
  FindNeighbors(dims = 1:50) %>%
  FindClusters() %>%
  RunUMAP(dims = 1:50)
```




## Preparation

### Conserved Markers

```{r}
CONSERVED_READ_CACHE = TRUE
```
```{r}
if(CONSERVED_READ_CACHE){conserved.mks.all.df <- read.csv(file = file.path(wd,"DE_analysis","results","conserved.mks.all.df.csv"), row.names = 1)}
```
```{r}
Idents(hpcs.lps.seurat) <- "cell_type_brief"
som.mks.conserved <- FindConservedMarkers(hpcs.lps.seurat, ident.1 = "Som", grouping.var = "hclust.AUC", only.pos = TRUE)
cort.mks.conserved <- FindConservedMarkers(hpcs.lps.seurat, ident.1 = "Cort", grouping.var = "hclust.AUC", only.pos = TRUE)
lac.mks.conserved <- FindConservedMarkers(hpcs.lps.seurat, ident.1 = "Lac", grouping.var = "hclust.AUC", only.pos = TRUE)
gonad.mks.conserved <- FindConservedMarkers(hpcs.lps.seurat, ident.1 = "Gonad", grouping.var = "hclust.AUC", only.pos = TRUE)
thyro.mks.conserved <- FindConservedMarkers(hpcs.lps.seurat, ident.1 = "Thyro", grouping.var = "hclust.AUC", only.pos = TRUE)
```

```{r}
CONSERVED_DO_PADJ_FILTER = TRUE
CONSERVED_PADJ_CUTOFF = 0.01

CONSERVED_DO_INFL_FILTER = TRUE
CONSERVED_INFL_FC_CUTOFF = 0.25

CONSERVED_DO_UNINFL_FILTER = TRUE
CONSERVED_UNINFL_FC_CUTOFF = 0.25
```
```{r}
# Apply cutoff
if(CONSERVED_DO_PADJ_FILTER){
  som.mks.conserved <- dplyr::filter(som.mks.conserved, minimump_p_val <= CONSERVED_PADJ_CUTOFF)
  cort.mks.conserved <- dplyr::filter(cort.mks.conserved, minimump_p_val <= CONSERVED_PADJ_CUTOFF)
  lac.mks.conserved <- dplyr::filter(lac.mks.conserved, minimump_p_val <= CONSERVED_PADJ_CUTOFF)
  gonad.mks.conserved <- dplyr::filter(gonad.mks.conserved, minimump_p_val <= CONSERVED_PADJ_CUTOFF)
  thyro.mks.conserved <- dplyr::filter(thyro.mks.conserved, minimump_p_val <= CONSERVED_PADJ_CUTOFF)
}
if(CONSERVED_DO_INFL_FILTER){
  som.mks.conserved <- dplyr::filter(som.mks.conserved, Inflammation_avg_logFC >= CONSERVED_INFL_FC_CUTOFF)
  cort.mks.conserved <- dplyr::filter(cort.mks.conserved, Inflammation_avg_logFC >= CONSERVED_INFL_FC_CUTOFF)
  lac.mks.conserved <- dplyr::filter(lac.mks.conserved, Inflammation_avg_logFC >= CONSERVED_INFL_FC_CUTOFF)
  gonad.mks.conserved <- dplyr::filter(gonad.mks.conserved, Inflammation_avg_logFC >= CONSERVED_INFL_FC_CUTOFF)
  thyro.mks.conserved <- dplyr::filter(thyro.mks.conserved, Inflammation_avg_logFC >= CONSERVED_INFL_FC_CUTOFF)
}
if(CONSERVED_DO_UNINFL_FILTER){
  som.mks.conserved <- dplyr::filter(som.mks.conserved, Healthy_avg_logFC >= CONSERVED_UNINFL_FC_CUTOFF)
  cort.mks.conserved <- dplyr::filter(cort.mks.conserved, Healthy_avg_logFC >= CONSERVED_UNINFL_FC_CUTOFF)
  lac.mks.conserved <- dplyr::filter(lac.mks.conserved, Healthy_avg_logFC >= CONSERVED_UNINFL_FC_CUTOFF)
  gonad.mks.conserved <- dplyr::filter(gonad.mks.conserved, Healthy_avg_logFC >= CONSERVED_UNINFL_FC_CUTOFF)
  thyro.mks.conserved <- dplyr::filter(thyro.mks.conserved, Healthy_avg_logFC >= CONSERVED_UNINFL_FC_CUTOFF)
}
```

```{r}
conserved.mks.all <- c(rownames(som.mks.conserved), rownames(cort.mks.conserved), rownames(lac.mks.conserved), rownames(gonad.mks.conserved), rownames(thyro.mks.conserved))
names(conserved.mks.all) <- c(rep('som',nrow(som.mks.conserved)),
                              rep('cort',nrow(cort.mks.conserved)),
                              rep('lac',nrow(lac.mks.conserved)),
                              rep('gonad',nrow(gonad.mks.conserved)),
                              rep('thyro',nrow(thyro.mks.conserved)))  # Setup names
# Prune duplicated genes, for plotting heatmap
conserved.mks.use.uniq <- conserved.mks.all[!duplicated(conserved.mks.all)]

# Combine and store all conserved genes into a dataframe
som.mks.conserved$cell_type <- "Som"; cort.mks.conserved$cell_type <- "Cort"; lac.mks.conserved$cell_type <- "Lac"; gonad.mks.conserved$cell_type <- "Gonad"; thyro.mks.conserved$cell_type <- "Thyro"
som.mks.conserved <- tibble::rownames_to_column(som.mks.conserved, var = "gene")
cort.mks.conserved <- tibble::rownames_to_column(cort.mks.conserved, var = "gene")
lac.mks.conserved <- tibble::rownames_to_column(lac.mks.conserved, var = "gene")
gonad.mks.conserved <- tibble::rownames_to_column(gonad.mks.conserved, var = "gene")
thyro.mks.conserved <- tibble::rownames_to_column(thyro.mks.conserved, var = "gene")
conserved.mks.all.df <- rbind(som.mks.conserved,cort.mks.conserved,lac.mks.conserved,gonad.mks.conserved,thyro.mks.conserved)
# conserved.mks.all.df <- conserved.mks.all.df[conserved.mks.use.uniq,]
# suppressPackageStartupMessages(library(org.Mm.eg.db))
# conserved.mks.all.df$symbol <- mapIds(org.Mm.eg.db, keys = rownames(conserved.mks.all.df), column = "SYMBOL", keytype = "ENSEMBL", multiVals = "first")

## A more secure way to convert ENSEMBL IDs to SYMBOLS (avoid NAs)
if(!SHORT_NAME){
  gencode.anno <- loadGencodeAnno()
  conserved.mks.all.df$symbol <- gencode.anno[match(conserved.mks.all.df$gene,gencode.anno$stable_id),"gene_short_name"]
}

write.csv(x = conserved.mks.all.df, file = file.path(wd,"DE_analysis","results","conserved.mks.all.df.csv"), quote = FALSE)
```

### DEGs between states (based on hclust.AUC)

```{r}
load(file.path(wd,"DE_analysis","results","de.lps.markers.use.dat"))
de.lps.markers.all.df <- read.csv(file = file.path(wd,"DE_analysis","results","de.lps.markers.all.df.csv"))
de.lps.markers.uniq.df <- read.csv(file = file.path(wd,"DE_analysis","results","de.lps.markers.uniq.df.csv"))
```
```{r}
DEG_DO_PADJ_FILTER = TRUE
DEG_PADJ_CUTOFF = 0.01

DEG_DO_LOGFC_FILTER = TRUE
DEG_LOGFC_CUTOFF = 0.25
```
```{r}
Idents(som) <- "hclust.AUC"; som.mks.state <- FindAllMarkers(som, only.pos = TRUE); som.mks.state$cell_type <- "Som"
Idents(cort) <- "hclust.AUC"; cort.mks.state <- FindAllMarkers(cort, only.pos = TRUE); cort.mks.state$cell_type <- "Cort"
Idents(lac) <- "hclust.AUC"; lac.mks.state <- FindAllMarkers(lac, only.pos = TRUE); lac.mks.state$cell_type <- "Lac"
Idents(gonad) <- "hclust.AUC"; gonad.mks.state <- FindAllMarkers(gonad, only.pos = TRUE); gonad.mks.state$cell_type <- "Gonad"
Idents(thyro) <- "hclust.AUC"; thyro.mks.state <- FindAllMarkers(thyro, only.pos = TRUE); thyro.mks.state$cell_type <- "Thyro"
```
```{r}
if(DEG_DO_PADJ_FILTER){
  som.mks.state <- som.mks.state[som.mks.state$p_val_adj<=DEG_PADJ_CUTOFF,]
  cort.mks.state <- cort.mks.state[cort.mks.state$p_val_adj<=DEG_PADJ_CUTOFF,]
  lac.mks.state <- lac.mks.state[lac.mks.state$p_val_adj<=DEG_PADJ_CUTOFF,]
  gonad.mks.state <- gonad.mks.state[gonad.mks.state$p_val_adj<=DEG_PADJ_CUTOFF,]
  thyro.mks.state <- thyro.mks.state[thyro.mks.state$p_val_adj<=DEG_PADJ_CUTOFF,]
}
if(DEG_DO_LOGFC_FILTER){
  som.mks.state <- som.mks.state[som.mks.state$avg_logFC>=DEG_LOGFC_CUTOFF,]
  cort.mks.state <- cort.mks.state[cort.mks.state$avg_logFC>=DEG_LOGFC_CUTOFF,]
  lac.mks.state <- lac.mks.state[lac.mks.state$avg_logFC>=DEG_LOGFC_CUTOFF,]
  gonad.mks.state <- gonad.mks.state[gonad.mks.state$avg_logFC>=DEG_LOGFC_CUTOFF,]
  thyro.mks.state <- thyro.mks.state[thyro.mks.state$avg_logFC>=DEG_LOGFC_CUTOFF,]
}
```
```{r}
# Prune genes overlapping with conserved genes: maybe not necessary?
# Definitely NOT! It appears that a gene identified as a Conserved marker for a cell type across conditions could certainly as well be identified as a DEG within that cell type across conditions. (e.g. Crhr1 as both a conserved marker, and as a DEG across infl.-uninfl. conditions in our dataset)
# som.mks.state <- som.mks.state[!(som.mks.state$gene %in% conserved.mks.all),]
# cort.mks.state <- cort.mks.state[!(cort.mks.state$gene %in% conserved.mks.all),]
# lac.mks.state <- lac.mks.state[!(lac.mks.state$gene %in% conserved.mks.all),]
# gonad.mks.state <- gonad.mks.state[!(gonad.mks.state$gene %in% conserved.mks.all),]
# thyro.mks.state <- thyro.mks.state[!(thyro.mks.state$gene %in% conserved.mks.all),]

# Concatenate
de.lps.markers.use <- c(som.mks.state$gene, cort.mks.state$gene, lac.mks.state$gene, gonad.mks.state$gene, thyro.mks.state$gene)

ct_state_leiden <- c(rep('Som infl', sum(som.mks.state$cluster=="Inflammation")),
                     rep('Som health', sum(som.mks.state$cluster=="Healthy")),
                     rep('Cort infl', sum(cort.mks.state$cluster=="Inflammation")),
                     rep('Cort health', sum(cort.mks.state$cluster=="Healthy")),
                     rep('Lac infl', sum(lac.mks.state$cluster=="Inflammation")),
                     rep('Lac health', sum(lac.mks.state$cluster=="Healthy")),
                     rep('Gonad infl', sum(gonad.mks.state$cluster=="Inflammation")),
                     rep('Gonad health', sum(gonad.mks.state$cluster=="Healthy")),
                     rep('Thyro infl', sum(thyro.mks.state$cluster=="Inflammation")),
                     rep('Thyro health', sum(thyro.mks.state$cluster=="Healthy")))
names(de.lps.markers.use) <- ct_state_leiden
any(is.na(names(de.lps.markers.use)))  # Make sure that all name fields are filled
save(de.lps.markers.use, file = file.path(wd,"DE_analysis","results","de.lps.markers.use.dat"))

# Remove duplicated elements (keeping names)
de.lps.markers.use.uniq <- de.lps.markers.use[!duplicated(de.lps.markers.use)]

# Combine and store all de genes into a dataframe
de.lps.markers.all.df <- rbind(som.mks.state,cort.mks.state,lac.mks.state,gonad.mks.state,thyro.mks.state)
de.lps.markers.all.df$ct_state_leiden <- as.factor(ct_state_leiden)
de.lps.markers.uniq.df <- de.lps.markers.all.df[de.lps.markers.use.uniq,]
# if (!"org.Mm.eg.db" %in% (.packages())){suppressPackageStartupMessages(library(org.Mm.eg.db))}
# de.lps.markers.all.df$symbol <- mapIds(org.Mm.eg.db, keys = de.lps.markers.all.df$gene, column = "SYMBOL", keytype = "ENSEMBL", multiVals = "first")
# de.lps.markers.uniq.df$symbol <- mapIds(org.Mm.eg.db, keys = de.lps.markers.uniq.df$gene, column = "SYMBOL", keytype = "ENSEMBL", multiVals = "first")

## A more secure way to convert ENSEMBL IDs to SYMBOLS (avoid NAs)
if(!SHORT_NAME){
  rownames(de.lps.markers.all.df) <- NULL
  rownames(de.lps.markers.uniq.df) <- NULL
  de.lps.markers.all.df$symbol <- gencode.anno[match(de.lps.markers.all.df$gene,gencode.anno$stable_id),"gene_short_name"]
  de.lps.markers.uniq.df$symbol <- gencode.anno[match(de.lps.markers.uniq.df$gene,gencode.anno$stable_id),"gene_short_name"]
}

write.csv(x = de.lps.markers.all.df, file = file.path(wd,"DE_analysis","results","de.lps.markers.all.df.csv"), quote = FALSE)
write.csv(x = de.lps.markers.uniq.df, file = file.path(wd,"DE_analysis","results","de.lps.markers.uniq.df.csv"), quote = FALSE)
```

### Venn Relationships

```{r}
NA_REMOVE = FALSE
```

Up-regulated genes during inflammation.
In fact there's a good way to approach this intersection problem, simply using dataframe manipulations with dplyr.
```{r}
all.up.genes.df <- de.lps.markers.all.df[de.lps.markers.all.df$ct_state_leiden %in% c("Som infl","Cort infl","Lac infl","Gonad infl","Thyro infl"),c("cluster","gene","symbol","ct_state_leiden")]
all.up.genes.df$initial <- substr(all.up.genes.df$ct_state_leiden, start=1, stop =1)
all.up.genes.df <- all.up.genes.df %>% dplyr::group_by(gene) %>% dplyr::mutate(relationship = paste0(initial, collapse = ":")) %>% dplyr::select(-c(ct_state_leiden, initial)) %>% dplyr::distinct()

if(NA_REMOVE){
  all.up.genes.df <- all.up.genes.df[!is.na(all.up.genes.df$symbol),]
}

all.up.genes.df$category <- "up-regulated"
```

Down-regulated genes during inflammation.
```{r}
all.down.genes.df <- de.lps.markers.all.df[de.lps.markers.all.df$ct_state_leiden %in% c("Som health","Cort health","Lac health","Gonad health","Thyro health"),c("cluster","gene","symbol","ct_state_leiden")]
all.down.genes.df$initial <- substr(all.down.genes.df$ct_state_leiden, start=1, stop = 1)
all.down.genes.df <- all.down.genes.df %>% dplyr::group_by(gene) %>% dplyr::mutate(relationship = paste0(initial, collapse = ":")) %>% dplyr::select(-c(ct_state_leiden, initial)) %>% dplyr::distinct()

if(NA_REMOVE){
  # Remove entries with NA symbols
  all.down.genes.df <- all.down.genes.df[!is.na(all.down.genes.df$symbol),]  # dropped 2 genes in this step due to NA symbols
}

all.down.genes.df$category <- "down-regulated"
```
```{r}
de.genes.relationships.df <- rbind(all.up.genes.df, all.down.genes.df)
write.csv(de.genes.relationships.df, file = file.path(wd,"DE_analysis","results","de.genes.relationships.df.csv"), quote = FALSE)
```




### Obsolete but reserved for (possible) future reference

Manually curate gene list to be used as conserved markers:
  1. No duplicates
  2. No common element exists between conserved mks and DE mks

```{r}
# Remove unannotated genes
Gm <- all.conserved.mks[grep(all.conserved.mks, pattern = 'Gm\\d')]
conserved.mks.use <- all.conserved.mks[-which(all.conserved.mks %in% Gm)]
Rik <- all.conserved.mks[grep(all.conserved.mks, pattern = '\\d*Rik')]
conserved.mks.use <- conserved.mks.use[-which(conserved.mks.use %in% Rik)]

# Remove genes occured in DE analyses of LPS/Saline treatment comparisons
som.lps.de.state.res.0.1.sig.pos<-som.lps.de.state.res.0.1[som.lps.de.state.res.0.1$avg_logFC>0&som.lps.de.state.res.0.1$p_val_adj<0.01,]
cort.lps.de.state.res.0.1.sig.pos<-cort.lps.de.state.res.0.1[cort.lps.de.state.res.0.1$avg_logFC>0&cort.lps.de.state.res.0.1$p_val_adj<0.01,]
lac.lps.de.state.res.0.1.sig.pos<-lac.lps.de.state.res.0.1[lac.lps.de.state.res.0.1$avg_logFC>0&lac.lps.de.state.res.0.1$p_val_adj<0.01,]
gonad.lps.de.state.res.0.1.sig.pos<-gonad.lps.de.state.res.0.1[gonad.lps.de.state.res.0.1$avg_logFC>0&gonad.lps.de.state.res.0.1$p_val_adj<0.01,]
thyro.lps.de.state.res.0.2.sig.pos<-thyro.lps.de.state.res.0.2[thyro.lps.de.state.res.0.2$avg_logFC>0&thyro.lps.de.state.res.0.2$p_val_adj<0.01,]
conserved.mks.use <- conserved.mks.use[!conserved.mks.use %in% intersect(conserved.mks.use,som.lps.de.state.res.0.1.sig.pos$gene)]
conserved.mks.use <- conserved.mks.use[!conserved.mks.use %in% intersect(conserved.mks.use,cort.lps.de.state.res.0.1.sig.pos$gene)]
conserved.mks.use <- conserved.mks.use[!conserved.mks.use %in% intersect(conserved.mks.use,lac.lps.de.state.res.0.1.sig.pos$gene)]
conserved.mks.use <- conserved.mks.use[!conserved.mks.use %in% intersect(conserved.mks.use,gonad.lps.de.state.res.0.1.sig.pos$gene)]
conserved.mks.use <- conserved.mks.use[!conserved.mks.use %in% intersect(conserved.mks.use,thyro.lps.de.state.res.0.2.sig.pos$gene)]
conserved.mks.use <- setNames(c("Gh",conserved.mks.use), c("som",names(conserved.mks.use)))  # Manually add back "Gh", set names
length(conserved.mks.use)  # 231 conserved markers left
sum(names(conserved.mks.use) == "som")  # 20 conserved markers for Som
sum(names(conserved.mks.use) == "cort")  # 17 conserved markers for Cort
sum(names(conserved.mks.use) == "lac")  # 73 conserved markers for Lac
sum(names(conserved.mks.use) == "gonad")  #100 conserved markers for Gonad
sum(names(conserved.mks.use) == "thyro")  # 21 conserved markers for Thyro

# What genes are duplicated?
conserved.mks.use[which(duplicated(conserved.mks.use))]

# Remove duplicated genes, keeping only unique genes.
# conserved.mks.use <- unique(conserved.mks.use)  # This removes names, use another method
conserved.mks.use.uniq <- conserved.mks.use[!duplicated(conserved.mks.use)]

# Backup
# write.table(conserved.mks.use, file = file.path(wd,'DE_analysis','conserved.mks.use.txt'), quote = FALSE, sep = '\t', row.names = names(conserved.mks.use), col.names = FALSE)
```